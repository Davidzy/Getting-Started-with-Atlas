var width = 960,
    height = 500;

var x = d3.scale.linear()
    .range([0, width]);

var y = d3.scale.linear()
    .range([0, height - 40]);

// An SVG element with a bottom-right origin.
var svg = d3.select("#graph").append("svg")
    .attr("width", width)
    .attr("height", height)
    .style("padding-right", "30px")
  .append("g")
    .attr("transform", "translate(" + x(1) + "," + (height - 20) + ")scale(-1,-1)");

// A sliding container to hold the bars.
var body = svg.append("g")
    .attr("transform", "translate(0,0)");

// A container to hold the y-axis rules.
var rules = svg.append("g");

// A label for the current year.
var title = svg.append("text")
    .attr("class", "title")
    .attr("dy", ".71em")
    .attr("transform", "translate(" + x(1) + "," + y(1) + ")scale(-1,-1)")
    .text(2000);

var data = d3.csv.parse("year,age,sex,people\n1850,0,1,1483789\n1850,0,2,1450376\n1850,5,1,1411067\n1850,5,2,1359668\n1850,10,1,1260099\n1850,10,2,1216114\n1850,15,1,1077133\n1850,15,2,1110619\n1850,20,1,1017281\n1850,20,2,1003841\n1850,25,1,862547\n1850,25,2,799482\n1850,30,1,730638\n1850,30,2,639636\n1850,35,1,588487\n1850,35,2,505012\n1850,40,1,475911\n1850,40,2,428185\n1850,45,1,384211\n1850,45,2,341254\n1850,50,1,321343\n1850,50,2,286580\n1850,55,1,194080\n1850,55,2,187208\n1850,60,1,174976\n1850,60,2,162236\n1850,65,1,106827\n1850,65,2,105534\n1850,70,1,73677\n1850,70,2,71762\n1850,75,1,40834\n1850,75,2,40229\n1850,80,1,23449\n1850,80,2,22949\n1850,85,1,8186\n1850,85,2,10511\n1850,90,1,5259\n1850,90,2,6569\n1860,0,1,2120846\n1860,0,2,2092162\n1860,5,1,1804467\n1860,5,2,1778772\n1860,10,1,1612640\n1860,10,2,1540350\n1860,15,1,1438094\n1860,15,2,1495999\n1860,20,1,1351121\n1860,20,2,1370462\n1860,25,1,1217615\n1860,25,2,1116373\n1860,30,1,1043174\n1860,30,2,936055\n1860,35,1,866910\n1860,35,2,737136\n1860,40,1,699434\n1860,40,2,616826\n1860,45,1,552404\n1860,45,2,461739\n1860,50,1,456176\n1860,50,2,407305\n1860,55,1,292417\n1860,55,2,267224\n1860,60,1,260887\n1860,60,2,249735\n1860,65,1,149331\n1860,65,2,141405\n1860,70,1,98465\n1860,70,2,101778\n1860,75,1,56699\n1860,75,2,57597\n1860,80,1,29007\n1860,80,2,29506\n1860,85,1,10434\n1860,85,2,14053\n1860,90,1,7232\n1860,90,2,6622\n1870,0,1,2800083\n1870,0,2,2717102\n1870,5,1,2428469\n1870,5,2,2393680\n1870,10,1,2427341\n1870,10,2,2342670\n1870,15,1,1958390\n1870,15,2,2077248\n1870,20,1,1805303\n1870,20,2,1909382\n1870,25,1,1509059\n1870,25,2,1574285\n1870,30,1,1251534\n1870,30,2,1275629\n1870,35,1,1185336\n1870,35,2,1137490\n1870,40,1,968861\n1870,40,2,944401\n1870,45,1,852672\n1870,45,2,747916\n1870,50,1,736387\n1870,50,2,637801\n1870,55,1,486036\n1870,55,2,407819\n1870,60,1,399264\n1870,60,2,374801\n1870,65,1,260829\n1870,65,2,239080\n1870,70,1,173364\n1870,70,2,165501\n1870,75,1,86929\n1870,75,2,89540\n1870,80,1,47427\n1870,80,2,54190\n1870,85,1,15891\n1870,85,2,19302\n1870,90,1,8649\n1870,90,2,13068\n1880,0,1,3533662\n1880,0,2,3421597\n1880,5,1,3297503\n1880,5,2,3179142\n1880,10,1,2911924\n1880,10,2,2813550\n1880,15,1,2457734\n1880,15,2,2527818\n1880,20,1,2547780\n1880,20,2,2512803\n1880,25,1,2119393\n1880,25,2,1974241\n1880,30,1,1749107\n1880,30,2,1596772\n1880,35,1,1540772\n1880,35,2,1483717\n1880,40,1,1237347\n1880,40,2,1239435\n1880,45,1,1065973\n1880,45,2,1003711\n1880,50,1,964484\n1880,50,2,863012\n1880,55,1,679147\n1880,55,2,594843\n1880,60,1,580298\n1880,60,2,526956\n1880,65,1,369398\n1880,65,2,346303\n1880,70,1,255422\n1880,70,2,251860\n1880,75,1,141628\n1880,75,2,143513\n1880,80,1,67526\n1880,80,2,77290\n1880,85,1,22437\n1880,85,2,31227\n1880,90,1,10272\n1880,90,2,15451\n1900,0,1,4619544\n1900,0,2,4589196\n1900,5,1,4465783\n1900,5,2,4390483\n1900,10,1,4057669\n1900,10,2,4001749\n1900,15,1,3774846\n1900,15,2,3801743\n1900,20,1,3694038\n1900,20,2,3751061\n1900,25,1,3389280\n1900,25,2,3236056\n1900,30,1,2918964\n1900,30,2,2665174\n1900,35,1,2633883\n1900,35,2,2347737\n1900,40,1,2261070\n1900,40,2,2004987\n1900,45,1,1868413\n1900,45,2,1648025\n1900,50,1,1571038\n1900,50,2,1411981\n1900,55,1,1161908\n1900,55,2,1064632\n1900,60,1,916571\n1900,60,2,887508\n1900,65,1,672663\n1900,65,2,640212\n1900,70,1,454747\n1900,70,2,440007\n1900,75,1,268211\n1900,75,2,265879\n1900,80,1,127435\n1900,80,2,132449\n1900,85,1,44008\n1900,85,2,48614\n1900,90,1,15164\n1900,90,2,20093\n1910,0,1,5296823\n1910,0,2,5287477\n1910,5,1,4991803\n1910,5,2,4866139\n1910,10,1,4650747\n1910,10,2,4471887\n1910,15,1,4566154\n1910,15,2,4592269\n1910,20,1,4637632\n1910,20,2,4447683\n1910,25,1,4257755\n1910,25,2,3946153\n1910,30,1,3658125\n1910,30,2,3295220\n1910,35,1,3427518\n1910,35,2,3088990\n1910,40,1,2860229\n1910,40,2,2471267\n1910,45,1,2363801\n1910,45,2,2114930\n1910,50,1,2126516\n1910,50,2,1773592\n1910,55,1,1508358\n1910,55,2,1317651\n1910,60,1,1189421\n1910,60,2,1090697\n1910,65,1,850159\n1910,65,2,813868\n1910,70,1,557936\n1910,70,2,547623\n1910,75,1,322679\n1910,75,2,350900\n1910,80,1,161715\n1910,80,2,174315\n1910,85,1,59699\n1910,85,2,62725\n1910,90,1,23929\n1910,90,2,28965\n1920,0,1,5934792\n1920,0,2,5694244\n1920,5,1,5789008\n1920,5,2,5693960\n1920,10,1,5401156\n1920,10,2,5293057\n1920,15,1,4724365\n1920,15,2,4779936\n1920,20,1,4549411\n1920,20,2,4742632\n1920,25,1,4565066\n1920,25,2,4529382\n1920,30,1,4110771\n1920,30,2,3982426\n1920,35,1,4081543\n1920,35,2,3713810\n1920,40,1,3321923\n1920,40,2,3059757\n1920,45,1,3143891\n1920,45,2,2669089\n1920,50,1,2546035\n1920,50,2,2200491\n1920,55,1,1880975\n1920,55,2,1674672\n1920,60,1,1587549\n1920,60,2,1382877\n1920,65,1,1095956\n1920,65,2,989901\n1920,70,1,714618\n1920,70,2,690097\n1920,75,1,417292\n1920,75,2,439465\n1920,80,1,187000\n1920,80,2,211110\n1920,85,1,75991\n1920,85,2,92829\n1920,90,1,22398\n1920,90,2,32085\n1930,0,1,5875250\n1930,0,2,5662530\n1930,5,1,6542592\n1930,5,2,6129561\n1930,10,1,6064820\n1930,10,2,5986529\n1930,15,1,5709452\n1930,15,2,5769587\n1930,20,1,5305992\n1930,20,2,5565382\n1930,25,1,4929853\n1930,25,2,5050229\n1930,30,1,4424408\n1930,30,2,4455213\n1930,35,1,4576531\n1930,35,2,4593776\n1930,40,1,4075139\n1930,40,2,3754022\n1930,45,1,3633152\n1930,45,2,3396558\n1930,50,1,3128108\n1930,50,2,2809191\n1930,55,1,2434077\n1930,55,2,2298614\n1930,60,1,1927564\n1930,60,2,1783515\n1930,65,1,1397275\n1930,65,2,1307312\n1930,70,1,919045\n1930,70,2,918509\n1930,75,1,536375\n1930,75,2,522716\n1930,80,1,246708\n1930,80,2,283579\n1930,85,1,88978\n1930,85,2,109210\n1930,90,1,30338\n1930,90,2,43483\n1940,0,1,5294628\n1940,0,2,5124653\n1940,5,1,5468378\n1940,5,2,5359099\n1940,10,1,5960416\n1940,10,2,5868532\n1940,15,1,6165109\n1940,15,2,6193701\n1940,20,1,5682414\n1940,20,2,5896002\n1940,25,1,5438166\n1940,25,2,5664244\n1940,30,1,5040048\n1940,30,2,5171522\n1940,35,1,4724804\n1940,35,2,4791809\n1940,40,1,4437392\n1940,40,2,4394061\n1940,45,1,4190187\n1940,45,2,4050290\n1940,50,1,3785735\n1940,50,2,3488396\n1940,55,1,2972069\n1940,55,2,2810000\n1940,60,1,2370232\n1940,60,2,2317790\n1940,65,1,1897678\n1940,65,2,1911117\n1940,70,1,1280023\n1940,70,2,1287711\n1940,75,1,713875\n1940,75,2,764915\n1940,80,1,359418\n1940,80,2,414761\n1940,85,1,127303\n1940,85,2,152131\n1940,90,1,42263\n1940,90,2,58119\n1950,0,1,8211806\n1950,0,2,7862267\n1950,5,1,6706601\n1950,5,2,6450863\n1950,10,1,5629744\n1950,10,2,5430835\n1950,15,1,5264129\n1950,15,2,5288742\n1950,20,1,5573308\n1950,20,2,5854227\n1950,25,1,6007254\n1950,25,2,6317332\n1950,30,1,5676022\n1950,30,2,5895178\n1950,35,1,5511364\n1950,35,2,5696261\n1950,40,1,5076985\n1950,40,2,5199224\n1950,45,1,4533177\n1950,45,2,4595842\n1950,50,1,4199164\n1950,50,2,4147295\n1950,55,1,3667351\n1950,55,2,3595158\n1950,60,1,3035038\n1950,60,2,3009768\n1950,65,1,2421234\n1950,65,2,2548250\n1950,70,1,1627920\n1950,70,2,1786831\n1950,75,1,1006530\n1950,75,2,1148469\n1950,80,1,511727\n1950,80,2,637717\n1950,85,1,182821\n1950,85,2,242798\n1950,90,1,54836\n1950,90,2,90766\n1960,0,1,10374975\n1960,0,2,10146999\n1960,5,1,9495503\n1960,5,2,9250741\n1960,10,1,8563700\n1960,10,2,8310764\n1960,15,1,6620902\n1960,15,2,6617493\n1960,20,1,5268384\n1960,20,2,5513495\n1960,25,1,5311805\n1960,25,2,5548259\n1960,30,1,5801342\n1960,30,2,6090862\n1960,35,1,6063063\n1960,35,2,6431337\n1960,40,1,5657943\n1960,40,2,5940520\n1960,45,1,5345658\n1960,45,2,5516028\n1960,50,1,4763364\n1960,50,2,4928844\n1960,55,1,4170581\n1960,55,2,4402878\n1960,60,1,3405293\n1960,60,2,3723839\n1960,65,1,2859371\n1960,65,2,3268699\n1960,70,1,2115763\n1960,70,2,2516479\n1960,75,1,1308913\n1960,75,2,1641371\n1960,80,1,619923\n1960,80,2,856952\n1960,85,1,253245\n1960,85,2,384572\n1960,90,1,75908\n1960,90,2,135774\n1970,0,1,8685121\n1970,0,2,8326887\n1970,5,1,10411131\n1970,5,2,10003293\n1970,10,1,10756403\n1970,10,2,10343538\n1970,15,1,9605399\n1970,15,2,9414284\n1970,20,1,7729202\n1970,20,2,8341830\n1970,25,1,6539301\n1970,25,2,6903041\n1970,30,1,5519879\n1970,30,2,5851441\n1970,35,1,5396732\n1970,35,2,5708021\n1970,40,1,5718538\n1970,40,2,6129319\n1970,45,1,5794120\n1970,45,2,6198742\n1970,50,1,5298312\n1970,50,2,5783817\n1970,55,1,4762911\n1970,55,2,5222164\n1970,60,1,4037643\n1970,60,2,4577251\n1970,65,1,3142606\n1970,65,2,3894827\n1970,70,1,2340826\n1970,70,2,3138009\n1970,75,1,1599269\n1970,75,2,2293376\n1970,80,1,886155\n1970,80,2,1417553\n1970,85,1,371123\n1970,85,2,658511\n1970,90,1,186502\n1970,90,2,314929\n1980,0,1,8439366\n1980,0,2,8081854\n1980,5,1,8680730\n1980,5,2,8275881\n1980,10,1,9452338\n1980,10,2,9048483\n1980,15,1,10698856\n1980,15,2,10410271\n1980,20,1,10486776\n1980,20,2,10614947\n1980,25,1,9624053\n1980,25,2,9827903\n1980,30,1,8705835\n1980,30,2,8955225\n1980,35,1,6852069\n1980,35,2,7134239\n1980,40,1,5692148\n1980,40,2,5953910\n1980,45,1,5342469\n1980,45,2,5697543\n1980,50,1,5603709\n1980,50,2,6110117\n1980,55,1,5485098\n1980,55,2,6160229\n1980,60,1,4696140\n1980,60,2,5456885\n1980,65,1,3893510\n1980,65,2,4896947\n1980,70,1,2857774\n1980,70,2,3963441\n1980,75,1,1840438\n1980,75,2,2951759\n1980,80,1,1012886\n1980,80,2,1919292\n1980,85,1,472338\n1980,85,2,1023115\n1980,90,1,204148\n1980,90,2,499046\n1990,0,1,9307465\n1990,0,2,8894007\n1990,5,1,9274732\n1990,5,2,8799955\n1990,10,1,8782542\n1990,10,2,8337284\n1990,15,1,9020572\n1990,15,2,8590991\n1990,20,1,9436188\n1990,20,2,9152644\n1990,25,1,10658027\n1990,25,2,10587292\n1990,30,1,11028712\n1990,30,2,11105750\n1990,35,1,9853933\n1990,35,2,10038644\n1990,40,1,8712632\n1990,40,2,8928252\n1990,45,1,6848082\n1990,45,2,7115129\n1990,50,1,5553992\n1990,50,2,5899925\n1990,55,1,4981670\n1990,55,2,5460506\n1990,60,1,4953822\n1990,60,2,5663205\n1990,65,1,4538398\n1990,65,2,5594108\n1990,70,1,3429420\n1990,70,2,4610222\n1990,75,1,2344932\n1990,75,2,3723980\n1990,80,1,1342996\n1990,80,2,2545730\n1990,85,1,588790\n1990,85,2,1419494\n1990,90,1,238459\n1990,90,2,745146\n2000,0,1,9735380\n2000,0,2,9310714\n2000,5,1,10552146\n2000,5,2,10069564\n2000,10,1,10563233\n2000,10,2,10022524\n2000,15,1,10237419\n2000,15,2,9692669\n2000,20,1,9731315\n2000,20,2,9324244\n2000,25,1,9659493\n2000,25,2,9518507\n2000,30,1,10205879\n2000,30,2,10119296\n2000,35,1,11475182\n2000,35,2,11635647\n2000,40,1,11320252\n2000,40,2,11488578\n2000,45,1,9925006\n2000,45,2,10261253\n2000,50,1,8507934\n2000,50,2,8911133\n2000,55,1,6459082\n2000,55,2,6921268\n2000,60,1,5123399\n2000,60,2,5668961\n2000,65,1,4453623\n2000,65,2,4804784\n2000,70,1,3792145\n2000,70,2,5184855\n2000,75,1,2912655\n2000,75,2,4355644\n2000,80,1,1902638\n2000,80,2,3221898\n2000,85,1,970357\n2000,85,2,1981156\n2000,90,1,336303\n2000,90,2,1064581");

//d3.csv("sample-data.csv", function(data) {

  // Convert strings to numbers.
  data.forEach(function(d) {
    d.people = +d.people;
    d.year = +d.year;
    d.age = +d.age;
  });

  // Compute the extent of the data set in age and years.
  var age0 = 0,
      age1 = d3.max(data, function(d) { return d.age; }),
      year0 = d3.min(data, function(d) { return d.year; }),
      year1 = d3.max(data, function(d) { return d.year; }),
      year = year1;

  // Update the scale domains.
  x.domain([0, age1 + 5]);
  y.domain([0, d3.max(data, function(d) { return d.people; })]);

  // Add rules to show the population values.
  rules = rules.selectAll(".rule")
      .data(y.ticks(10))
    .enter().append("g")
      .attr("class", "rule")
      .attr("transform", function(d) { return "translate(0," + y(d) + ")"; });

  rules.append("line")
      .attr("x2", width);

  rules.append("text")
      .attr("x", 6)
      .attr("dy", ".35em")
      .attr("transform", "rotate(180)")
      .text(function(d) { return Math.round(d / 1e6) + "M"; });

  // Add labeled rects for each birthyear.
  var years = body.selectAll("g")
      .data(d3.range(year0 - age1, year1 + 5, 5))
    .enter().append("g")
      .attr("transform", function(d) { return "translate(" + x(year1 - d) + ",0)"; });

  years.selectAll("rect")
      .data(d3.range(2))
    .enter().append("rect")
      .attr("x", 1)
      .attr("width", x(5) - 2)
      .attr("height", 1e-6);

  years.append("text")
      .attr("y", -6)
      .attr("x", -x(5) / 2)
      .attr("transform", "rotate(180)")
      .attr("text-anchor", "middle")
      .style("fill", "#fff")
      .text(String);

  // Add labels to show the age.
  svg.append("g").selectAll("text")
      .data(d3.range(0, age1 + 5, 5))
    .enter().append("text")
      .attr("text-anchor", "middle")
      .attr("transform", function(d) { return "translate(" + (x(d) + x(5) / 2) + ",-4)scale(-1,-1)"; })
      .attr("dy", ".71em")
      .text(String);

  // Nest by year then birthyear.
  data = d3.nest()
      .key(function(d) { return d.year; })
      .key(function(d) { return d.year - d.age; })
      .rollup(function(v) { return v.map(function(d) { return d.people; }); })
      .map(data);

  // Allow the arrow keys to change the displayed year.
  d3.select(window).on("keydown", function() {
    switch (d3.event.keyCode) {
      case 37: year = Math.max(year0, year - 10); break;
      case 39: year = Math.min(year1, year + 10); break;
    }
    redraw();
//  });

  redraw();

  function redraw() {
    if (!(year in data)) return;
    title.text(year);

    body.transition()
        .duration(750)
        .attr("transform", function(d) { return "translate(" + x(year - year1) + ",0)"; });

    years.selectAll("rect")
        .data(function(d) { return data[year][d] || [0, 0]; })
      .transition()
        .duration(750)
        .attr("height", y);
  }
});
